"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _asyncToGenerator(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,i){function r(n,a){try{var s=t[n](a),o=s.value}catch(e){return void i(e)}if(!s.done)return Promise.resolve(o).then(function(e){r("next",e)},function(e){r("throw",e)});e(o)}return r("next")})}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),_wepy=require("./../../npm/wepy/lib/wepy.js"),_wepy2=_interopRequireDefault(_wepy),Drawer=function(e){function t(){var e,i,r,n;_classCallCheck(this,t);for(var a=arguments.length,s=Array(a),o=0;o<a;o++)s[o]=arguments[o];return i=r=_possibleConstructorReturn(this,(e=t.__proto__||Object.getPrototypeOf(t)).call.apply(e,[this].concat(s))),r.props={painting:{type:Object,default:{}}},r.data={showCanvas:!1,width:100,height:100,index:0,imageList:[],tempFileList:[],isPainting:!1,ctx:null,cache:{}},r.watch={painting:function(e,t){this.isPainting||(JSON.stringify(e)!==JSON.stringify(t)?e&&e.width&&e.height&&(this.showCanvas=!0,this.isPainting=!0,this.$apply(),this.readyPigment()):e&&"same"!==e.mode&&this.$emit("getImage",{errMsg:"canvasdrawer:samme params"}))}},r.methods={},n=i,_possibleConstructorReturn(r,n)}return _inherits(t,e),_createClass(t,[{key:"readyPigment",value:function(){var e=this,t=this.painting,i=t.width,r=t.height,n=t.views;this.width=i,this.height=r;var a=setInterval(function(){e.ctx&&(clearInterval(a),e.ctx.clearActions(),e.ctx.save(),e.getImageList(n),setTimeout(function(){return e.downLoadImages(0)},100))},100)}},{key:"getImageList",value:function(e){for(var t=[],i=0;i<e.length;i++)"image"===e[i].type&&t.push(e[i].url);this.imageList=t}},{key:"downLoadImages",value:function(e){var t=this,i=this.imageList,r=this.tempFileList;e<i.length?this.getImageInfo(i[e]).then(function(i){r.push(i),t.tempFileList=r,t.downLoadImages(e+1)}):this.startPainting()}},{key:"startPainting",value:function(){for(var e=this,t=this.tempFileList,i=this.painting.views,r=0,n=0;r<i.length;r++)if("image"===i[r].type)this.drawImage(_extends({},i[r],{url:t[n]})),n++;else if("text"===i[r].type){if(!this.ctx.measureText)return _wepy2.default.showModal({title:"提示",content:"当前微信版本过低，无法使用 measureText 功能，请升级到最新微信版本后重试。"}),void this.$emit("getImage",{errMsg:"canvasdrawer:version too low"});this.drawText(i[r])}else"rect"===i[r].type&&this.drawRect(i[r]);this.ctx.draw(!1,function(){_wepy2.default.setStorageSync("canvasdrawer_pic_cache",e.cache),e.saveImageToLocal()})}},{key:"drawImage",value:function(e){this.ctx.save();var t=e.url,i=e.top,r=void 0===i?0:i,n=e.left,a=void 0===n?0:n,s=e.width,o=void 0===s?0:s,c=e.height,h=void 0===c?0:c;e.borderRadius;this.ctx.drawImage(t,a,r,o,h),this.ctx.restore()}},{key:"drawText",value:function(e){this.ctx.save();var t=e.MaxLineNumber,i=void 0===t?2:t,r=e.breakWord,n=void 0!==r&&r,a=e.color,s=void 0===a?"black":a,o=e.content,c=void 0===o?"":o,h=e.fontSize,u=void 0===h?16:h,l=e.top,f=void 0===l?0:l,d=e.left,p=void 0===d?0:d,g=e.lineHeight,v=void 0===g?20:g,w=e.textAlign,x=void 0===w?"left":w,m=e.width,y=e.bolder,_=void 0!==y&&y,b=e.textDecoration,T=void 0===b?"none":b;if(this.ctx.beginPath(),this.ctx.setTextBaseline("top"),this.ctx.setTextAlign(x),this.ctx.setFillStyle(s),this.ctx.setFontSize(u),n){for(var k="",I=f,L=1,P=0;P<c.length;P++)if(k+=[c[P]],this.ctx.measureText(k).width>m){if(L===i&&P!==c.length){k=k.substring(0,k.length-1)+"...",this.ctx.fillText(k,p,I),this.drawTextLine(p,I,T,s,u,k),k="";break}this.ctx.fillText(k,p,I),this.drawTextLine(p,I,T,s,u,k),k="",I+=v,L++}this.ctx.fillText(k,p,I),this.drawTextLine(p,I,T,s,u,k)}else this.ctx.fillText(c,p,f),this.drawTextLine(p,f,T,s,u,c);this.ctx.restore(),_&&this.drawText(_extends({},e,{left:p+.3,top:f+.3,bolder:!1,textDecoration:"none"}))}},{key:"drawTextLine",value:function(e,t,i,r,n,a){"underline"===i?this.drawRect({background:r,top:t+1.2*n,left:e-1,width:this.ctx.measureText(a).width+3,height:1}):"line-through"===i&&this.drawRect({background:r,top:t+.6*n,left:e-1,width:this.ctx.measureText(a).width+3,height:1})}},{key:"drawRect",value:function(e){this.ctx.save();var t=e.background,i=e.top,r=void 0===i?0:i,n=e.left,a=void 0===n?0:n,s=e.width,o=void 0===s?0:s,c=e.height,h=void 0===c?0:c;this.ctx.setFillStyle(t),this.ctx.fillRect(a,r,o,h),this.ctx.restore()}},{key:"getImageInfo",value:function(){function e(e){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(t){var i,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.cache[t]){e.next=4;break}return e.abrupt("return",this.cache[t]);case 4:if(i=new RegExp(/^http(s)?:\/\/([\w-]+\.)+[\w-]+(\/[\w- .\/?%&=]*)?/),!i.test(t)){e.next=18;break}return e.next=8,_wepy2.default.getImageInfo({src:t});case 8:if(r=e.sent,"getImageInfo:ok"!==r.errMsg){e.next=14;break}return this.cache[t]=r.path,e.abrupt("return",r.path);case 14:return this.$emit("getImage",{errMsg:"canvasdrawer:download fail"}),e.abrupt("return",new Error("getImageInfo fail"));case 16:e.next=20;break;case 18:return this.cache[t]=t,e.abrupt("return",t);case 20:case"end":return e.stop()}},e,this)}));return e}()},{key:"saveImageToLocal",value:function(){function e(){return t.apply(this,arguments)}var t=_asyncToGenerator(regeneratorRuntime.mark(function e(){var t,i,r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=this.width,i=this.height,e.next=3,_wepy2.default.canvasToTempFilePath({x:0,y:0,width:t,height:i,canvasId:"canvasdrawer"},this);case 3:r=e.sent,"canvasToTempFilePath:ok"===r.errMsg?(this.showCanvas=!1,this.isPainting=!1,this.imageList=[],this.tempFileList=[],this.$apply(),this.$emit("getImage",{tempFilePath:r.tempFilePath,errMsg:"canvasdrawer:ok"})):this.$emit("getImage",{errMsg:"canvasdrawer:fail"});case 5:case"end":return e.stop()}},e,this)}));return e}()},{key:"onLoad",value:function(){_wepy2.default.removeStorageSync("canvasdrawer_pic_cache"),this.cache=_wepy2.default.getStorageSync("canvasdrawer_pic_cache")||{},this.ctx=_wepy2.default.createCanvasContext("canvasdrawer",this)}}]),t}(_wepy2.default.component);exports.default=Drawer;